<!DOCTYPE html>
<html>
<head>
<title>Full PTZ Control</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
<style>
/* Base Styling for better mobile support and aesthetics */
body {
    font-family: 'Inter', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    background-color: #f0f0f0;
    padding: 10px;
    color: #1f2937; /* Dark gray text */
}

h1 {
    font-size: 2em;
    font-weight: 800;
    color: #10b981; /* Emerald green accent */
    margin-bottom: 5px;
}

h2 {
    font-size: 1.25em;
    font-weight: 600;
    color: #374151;
    margin-top: 10px;
}

/* Input/Select/Display Styling */
input[type="number"], input[type="text"], input[type="password"], select, #speedDisplay {
    padding: 8px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 10px;
    width: 100%;
    box-sizing: border-box;
    transition: border-color 0.3s;
}

input:focus, select:focus {
    border-color: #10b981;
    outline: none;
    box-shadow: 0 0 0 1px #10b981;
}

/* Form Container for organization */
.input-group-row {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
    width: 350px;
    max-width: 100%;
    align-items: center;
}

.input-group-row label {
    font-weight: 600;
    width: 80px;
    text-align: right;
}

.input-group-row input, .input-group-row select {
    flex-grow: 1;
}

/* Console Styling */
#rxConsole {
    width: 350px;
    max-width: 90vw;
    height: 150px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    resize: none;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    font-family: monospace;
    font-size: 0.8em;
    background-color: #ffffff;
}

/* Generic Button Styling (Base) */
button {
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    background-color: #34d399; /* Light green */
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s, transform 0.1s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

button:hover {
    background-color: #10b981; /* Emerald green */
}

button:active {
    transform: translateY(1px);
}

/* Main Layout Container */
#controlLayout {
    display: flex;
    flex-direction: row;
    gap: 30px;
    justify-content: center;
    max-width: 800px;
    flex-wrap: wrap; /* Wrap on mobile */
}

/* D-Pad Container Styling */
#dpadContainer {
    display: grid;
    grid-template-columns: repeat(3, 80px); 
    grid-template-rows: repeat(3, 80px);
    gap: 8px;
    margin: 20px auto;
    max-width: 264px;
}

/* D-Pad Button Styling */
.dpad-button {
    width: 100%;
    height: 100%;
    border-radius: 50%; /* Circular buttons */
    background-color: #007bff;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    font-size: 1.5em;
}

.dpad-button:hover {
    background-color: #0056b3;
}

.dpad-stop {
    background-color: #ef4444; /* Red for stop */
    border-radius: 6px;
    font-size: 1.2em;
}

.dpad-stop:hover {
    background-color: #dc2626;
}

.dpad-empty {
    visibility: hidden;
}

/* Lens Control Group Styling */
.lens-control-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    width: 300px;
    background-color: #ffffff;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.lens-control-group h3 {
    margin: 0 0 10px 0;
    color: #10b981;
    border-bottom: 1px dashed #e5e7eb;
    padding-bottom: 5px;
}

.lens-control-group .btn-row {
    display: flex;
    justify-content: space-around;
    gap: 5px;
    margin-bottom: 5px;
}

.lens-control-group .btn-row button {
    flex-grow: 1;
    margin: 3px 0;
    padding: 8px;
    font-size: 0.9em;
}

/* Specific button colors for distinction */
.btn-row:nth-child(2) button { background-color: #28a745; } /* Zoom/Wiper */
.focus-iris button { background-color: #ffc107; color: #1f2937; } /* Focus/Iris */

/* Status Displays */
#externalIpDisplay, #versionDisplay {
    margin: 15px 0;
    font-size: 1em;
    color: #374151;
    font-weight: 500;
}
</style>
<script>
// ===============================================
// == GLOBAL VARIABLES (CRITICAL FOR LINKING) ==
// ===============================================
var client;
var commandTopic = "ptz/commands/cam1";
var lastPan = NaN;
var lastTilt = NaN;

var currentSpeed = { pan: 0, tilt: 0 };

function init() {
    // ** MQTT CONNECTION CONFIGURATION **
    var host = "broker.hivemq.com";
    var port = 8884;
    var clientId = "WebClient-" + parseInt(Math.random() * 10000);

    // Paho.MQTT.Client constructor: (host, port, path, clientId)
    client = new Paho.MQTT.Client(host, port, "/mqtt", clientId);

    client.onConnectionLost = onConnectionLost;
    client.onMessageArrived = onMessageArrived;

    client.connect({
        onSuccess:onConnect,
        useSSL: true 
    });

    // Start the connection check and command loop
    setTimeout(checkConnectionAndStartLoop, 100);
}


function checkConnectionAndStartLoop() {
    // Check if the client object is connected AND initialized
    if (client && client.isConnected()) {
        document.getElementById("rxConsole").value += "Connection confirmed. Starting PTZ control loop.\n";

        // Start the continuous control loop (100ms rate to match firmware debounce)
        setInterval(sendProportionalCommand, 100);

    } else {
        // If connection not yet established, retry check
        setTimeout(checkConnectionAndStartLoop, 500);
    }
}

function onConnect() {
    document.getElementById("rxConsole").value += "Connected to MQTT Broker!\n";
    client.subscribe("ptz/status/#"); // Subscribe to all status topics
}

function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
        document.getElementById("rxConsole").value += "Connection lost: " + responseObject.errorMessage + "\n";
    }
}

function onMessageArrived(message) {
    var console = document.getElementById("rxConsole");
    console.value += "RX: [" + message.destinationName + "] " + message.payloadString + "\n";
    console.scrollTop = console.scrollHeight;

    // Optional: Parse specific status messages if needed
    if (message.destinationName === "ptz/status/external_ip") {
        document.getElementById("externalIpDisplay").innerText = "External IP: " + message.payloadString;
    }
}

// ** PROTOCOL HELPER **
function getCurrentProtocol() {
    return document.getElementById("protocolSelect").value;
}

// ** MOVEMENT CONTROL FUNCTIONS **
function movePTZ(direction) {
    // Reset to stop first
    currentSpeed.pan = 0;
    currentSpeed.tilt = 0;

    // Use absolute value of speed, direction is determined by sign
    const speed = Math.abs(parseInt(document.getElementById("speedInput").value) || 5);

    switch (direction) {
        case 'left':
            currentSpeed.pan = -speed; 
            break;
        case 'right':
            currentSpeed.pan = speed; 
            break;
        case 'up':
            currentSpeed.tilt = -speed; 
            break;
        case 'down':
            currentSpeed.tilt = speed; 
            break;
    }
}

function stopPTZ() {
    currentSpeed.pan = 0;
    currentSpeed.tilt = 0;
}

/**
 * Sets speed to zero and immediately forces the proportional command to be sent.
 * This guarantees an instantaneous STOP packet transmission.
 */
function sendImmediateStop() {
    lastPan = -1; // just to force the send of the stop again
    stopPTZ(); // Set state variables to 0
    sendProportionalCommand(); // Force send the 0, 0 command instantly
}


// *** CORE FUNCTION: SENDS PAN/TILT COMMAND ***
function sendProportionalCommand() {
    // Check for client connection before proceeding
    if (!client || !client.isConnected()) return;

    var panSpeed = currentSpeed.pan;
    var tiltSpeed = currentSpeed.tilt;

    // ** OPTIMIZATION: Prevent repetition of ANY command if the movement state is unchanged **
    // This reduces MQTT traffic significantly by only sending packets when speed or direction changes.
    if (panSpeed === lastPan && tiltSpeed === lastTilt) {
        return;
    }

    var secretCode = document.getElementById("secretCode").value;
    var cameraId = document.getElementById("cameraId").value; 
    var protocol = getCurrentProtocol(); // Get selected protocol

    // JSON payload for proportional control
    var messagePayload = JSON.stringify({
        pan: panSpeed,
        tilt: tiltSpeed,
        auth: secretCode,
        cameraId: parseInt(cameraId),
        protocol: protocol // <-- New protocol field
    });

    document.getElementById("speedDisplay").value = `Pan: ${panSpeed}, Tilt: ${tiltSpeed}`;

    var message = new Paho.MQTT.Message(messagePayload);
    message.destinationName = commandTopic;
    client.send(message);

    lastPan = panSpeed;
    lastTilt = tiltSpeed;
}

// ** MANUAL COMMAND HANDLERS **

/**
 * Sends a manual string command (e.g., 'Zoom(Tele)', 'SetPreset(1)').
 * @param {string} commandString - The full command string.
 */
function sendCommand(commandString) {
    // Ensure D-pad movement stops before sending a static command
    stopPTZ();

    if (!client || !client.isConnected()) return;

    var secretCode = document.getElementById("secretCode").value;
    var cameraId = document.getElementById("cameraId").value; 
    var protocol = getCurrentProtocol(); // Get selected protocol

    // JSON payload for manual text command
    var manualPayload = JSON.stringify({
        cmd: commandString,
        auth: secretCode,
        cameraId: parseInt(cameraId),
        protocol: protocol // <-- New protocol field
    });

    var message = new Paho.MQTT.Message(manualPayload);
    message.destinationName = commandTopic;
    client.send(message);

    document.getElementById("rxConsole").value += `TX CMD: ${commandString} (Protocol: ${protocol})\n`;
    document.getElementById("rxConsole").scrollTop = document.getElementById("rxConsole").scrollHeight;
}


function sendCustomCommand() {
    var text = document.getElementById("txBar").value;
    if (text) {
        // Send command and also send a STOP packet afterward for safety
        sendCommand(text);

        // If the command is NOT explicitly 'STOP', send a follow-up STOP
        if (text.toUpperCase() !== 'STOP') {
            setTimeout(() => sendCommand('STOP'), 50);
        }

        document.getElementById("txBar").value = "";
    }
}

function sendPresetCommand(commandType) {
    var presetId = document.getElementById('presetId').value;
    if (presetId) {
        var command = `${commandType}(${presetId})`;
        sendCommand(command);
    }
}

</script>
</head>
<body onload="javascript:init()">

<h1>Full PTZ Control</h1>

<div>
    <textarea id="rxConsole" readonly></textarea>
</div>

<div class="input-group-row">
    <label for="secretCode">Auth Code:</label>
    <input type="password" id="secretCode" placeholder="Enter Secret PTZ Code" value="123" />
</div>

<div class="input-group-row">
    <label for="cameraId">Camera ID:</label>
    <input type="number" id="cameraId" value="7" min="1" max="255">
</div>

<div class="input-group-row">
    <label for="protocolSelect">Protocol:</label>
    <select id="protocolSelect">
        <option value="FV">Forward Vision (FV)</option>
        <option value="PELCO_D">Pelco-D</option>
    </select>
</div>

<div class="input-group-row">
    <label for="speedInput">Speed:</label>
    <input type="number" id="speedInput" value="5" min="1" max="50" />
</div>

<div style="margin-bottom: 20px;">
    <button onclick="sendCommand('CheckForUpdate')">Check for Firmware Update</button>
</div>

<div id="externalIpDisplay">
    External IP: Fetching...
</div>

<hr style="width: 100%; border: none; border-top: 1px solid #ccc; margin: 10px 0;" />

<div id="controlLayout">

    <!-- Pan/Tilt Control -->
    <div>
        <h2>Pan/Tilt (Proportional)</h2>
        <div id="dpadContainer">
            <div class="dpad-empty"></div>
            <button class="dpad-button" onmousedown="movePTZ('up')" ontouchstart="movePTZ('up')" onmouseup="stopPTZ()" ontouchend="stopPTZ()" title="Tilt Up">▲</button>
            <div class="dpad-empty"></div>

            <button class="dpad-button" onmousedown="movePTZ('left')" ontouchstart="movePTZ('left')" onmouseup="stopPTZ()" ontouchend="stopPTZ()" title="Pan Left">◀</button>
            <!-- UPDATED STOP BUTTON TO USE sendImmediateStop -->
            <button class="dpad-button dpad-stop" 
                onmousedown="sendImmediateStop()" 
                ontouchstart="sendImmediateStop()" 
                onmouseup="sendImmediateStop()" 
                ontouchend="sendImmediateStop()" 
                title="Stop">STOP</button>
            <button class="dpad-button" onmousedown="movePTZ('right')" ontouchstart="movePTZ('right')" onmouseup="stopPTZ()" ontouchend="stopPTZ()" title="Pan Right">▶</button>

            <div class="dpad-empty"></div>
            <button class="dpad-button" onmousedown="movePTZ('down')" ontouchstart="movePTZ('down')" onmouseup="stopPTZ()" ontouchend="stopPTZ()" title="Tilt Down">▼</button>
            <div class="dpad-empty"></div>
        </div>
        <input type="text" id="speedDisplay" readonly value="Pan: 0, Tilt: 0" style="margin-top: -10px; text-align: center;"/>
    </div>

    <!-- Lens, Presets, and Aux Control -->
    <div>
        <h2>Lens & Presets (Discrete)</h2>

        <div class="lens-control-group">
            <h3>Zoom</h3>
            <div class="btn-row">
                <button onclick="sendCommand('Zoom(Tele)')">Tele (+)</button>
                <button onclick="sendCommand('Zoom(Wide)')">Wide (-)</button>
            </div>
        </div>

        <div class="lens-control-group">
            <h3>Focus & Iris</h3>
            <div class="btn-row">
                <button onclick="sendCommand('Focus(Far)')">Focus Far</button>
                <button onclick="sendCommand('Focus(Near)')">Focus Near</button>
            </div>
            <div class="btn-row focus-iris">
                <button onclick="sendCommand('Iris(Open)')">Iris Open</button>
                <button onclick="sendCommand('Iris(Close)')">Iris Close</button>
            </div>
        </div>

        <div class="lens-control-group">
            <h3>Presets</h3>
            <div class="btn-row">
                <input type="number" id="presetId" value="1" min="1" max="255" style="width: 50px; text-align: center; margin-bottom: 0px;">
                <button onclick="sendPresetCommand('SetPreset')">Set Preset</button>
                <button onclick="sendPresetCommand('CallPreset')">Call Preset</button>
            </div>
        </div>

        <div class="lens-control-group">
            <h3>Wiper / Aux</h3>
            <div class="btn-row">
                <button onclick="sendCommand('Wiper(On)')">Wiper On</button>
                <button onclick="sendCommand('Wiper(Off)')">Wiper Off</button>
            </div>
        </div>
        
        <div class="lens-control-group">
            <h3>Manual Command</h3>
            <input type="text" id="txBar" onkeydown="if(event.keyCode == 13) sendCustomCommand();" placeholder="e.g., STOP, Focus(Auto)" style="margin-bottom: 5px;"/>
            <button onclick="sendCustomCommand()">Send Custom Command</button>
        </div>
    </div>
</div>

<hr style="width: 100%; border: none; border-top: 1px solid #ccc; margin-top: 20px;" />

<div id="versionDisplay">Version: Client Ready</div>
</body>
</html>
